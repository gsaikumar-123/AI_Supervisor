<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Caller Console</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px}
    input,button{padding:6px 8px}
    pre{background:#f7f7f7;padding:8px;min-height:80px}
  </style>
</head>
<body>
  <h2>Caller Console</h2>
  <div>
    <label>Caller ID <input id="callerId" value=""></label>
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
  </div>
  <div style="margin-top:12px">
    <label>Question <input id="question" value=""></label>
    <button id="ask">Ask</button>
  </div>
  <h3>Notifications</h3>
  <pre id="out"></pre>
  <script>
    let es;
    function log(x){
      const el=document.getElementById('out');
      el.textContent = (new Date().toLocaleTimeString())+" "+x+"\n"+el.textContent;
    }
    document.getElementById('connect').onclick = ()=>{
      const id=document.getElementById('callerId').value.trim();
      if(!id) return;
      if(es) es.close();
      es = new EventSource('/api/stream/'+encodeURIComponent(id));
      es.onmessage = (e)=>{ log(e.data) };
      es.onerror = ()=>{ log('stream error') };
      log('connected');
    };
    document.getElementById('disconnect').onclick = ()=>{ if(es){ es.close(); log('disconnected'); } };
    document.getElementById('ask').onclick = async ()=>{
      const callerId=document.getElementById('callerId').value.trim();
      const question=document.getElementById('question').value.trim();
      const r = await fetch('/api/call',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({callerId,question})});
      const j = await r.json();
      log(JSON.stringify(j));
    };
  </script>
</body>
</html>