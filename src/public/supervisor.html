<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Supervisor Console</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ccc;padding:8px;text-align:left}
    tr:hover{background:#f6f6f6}
    .panel{margin-top:16px}
    textarea{width:100%;height:80px}
    button{padding:6px 12px}
  </style>
</head>
<body>
  <h2>Supervisor Console</h2>
  <div>
    <button id="refresh">Refresh</button>
    <label style="margin-left:12px">Filter:
      <select id="filter">
        <option value="">all</option>
        <option value="pending">pending</option>
        <option value="resolved">resolved</option>
        <option value="unresolved">unresolved</option>
      </select>
    </label>
  </div>
  <div class="panel">
    <table id="list">
      <thead><tr><th>ID</th><th>Caller</th><th>Question</th><th>Status</th><th>Created</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="panel">
    <h3>Request Details</h3>
    <div id="details">Select a request to view details</div>
    <div id="answerBox" style="display:none;margin-top:8px">
      <textarea id="answerText" placeholder="Type answer here"></textarea>
      <div style="margin-top:8px">
        <label><input type="checkbox" id="resolved" checked/> Mark resolved</label>
        <button id="submitAnswer">Submit Answer</button>
      </div>
    </div>
  </div>
  <script>
    let selectedId = null;
    async function fetchList(){
      const status = document.getElementById('filter').value;
      const url = '/api/requests' + (status?('?status='+encodeURIComponent(status)): '');
      const res = await fetch(url);
      const j = await res.json();
      const tbody = document.querySelector('#list tbody');
      tbody.innerHTML = '';
      (j.requests||[]).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.callerId}</td><td>${r.question}</td><td>${r.status}</td><td>${new Date(r.createdAt).toLocaleString()}</td>`;
        tr.onclick = ()=>selectRow(r.id);
        tbody.appendChild(tr);
      });
    }
    async function selectRow(id){
      selectedId = id;
      const res = await fetch('/api/requests/'+encodeURIComponent(id));
      if(res.status===404){ document.getElementById('details').innerText='Not found'; return }
      const r = await res.json();
      document.getElementById('details').innerHTML = `<pre>${JSON.stringify(r,null,2)}</pre>`;
      document.getElementById('answerBox').style.display = 'block';
    }
    document.getElementById('refresh').addEventListener('click', fetchList);
    document.getElementById('filter').addEventListener('change', fetchList);
    document.getElementById('submitAnswer').addEventListener('click', async ()=>{
      if(!selectedId) return alert('Select a request');
      const answerText = document.getElementById('answerText').value.trim();
      const resolved = document.getElementById('resolved').checked;
      if(!answerText) return alert('Answer required');
      const res = await fetch('/api/requests/'+encodeURIComponent(selectedId)+'/answer',{
        method:'POST',headers:{'content-type':'application/json'},
        body: JSON.stringify({ answerText, resolved })
      });
      const j = await res.json();
      alert(JSON.stringify(j));
      document.getElementById('answerText').value = '';
      fetchList();
    });
    fetchList();
  </script>
</body>
</html>